<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Keyboard - Functional Audio Test</title>
    <link rel="stylesheet" href="../src/kids-keyboard.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            min-height: 100vh;
            padding: 20px;
        }

        #app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 1000px;
            padding: 30px;
        }

        h1 {
            color: #4a5568;
            margin-bottom: 30px;
            text-align: center;
        }

        .audio-controls {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }

        .audio-controls h3 {
            color: #2d3748;
            margin-bottom: 15px;
            margin-top: 0;
        }

        .control-group {
            align-items: center;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-group label {
            font-weight: 500;
            min-width: 100px;
        }

        .toggle-button {
            background: #e2e8f0;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }

        .toggle-button.active {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }

        .slider {
            flex: 1;
            max-width: 200px;
        }

        .status-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            margin-bottom: 20px;
            padding: 15px;
        }

        .status-indicator.ready {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .audio-feedback {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            color: #1565c0;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .audio-feedback.active {
            background: #c8e6c9;
            border-color: #a5d6a7;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <h1>🎵 Kids Keyboard - Functional Audio Test</h1>

        <div id="audio-status" class="status-indicator">
            🔄 Initializing functional audio system...
        </div>

        <div class="audio-controls">
            <h3>🔊 Audio Settings (Functional Version)</h3>

            <div class="control-group">
                <label>Audio:</label>
                <button id="audio-toggle" class="toggle-button active">🔊 ON</button>
            </div>

            <div class="control-group">
                <label>Speed:</label>
                <input type="range" id="speech-rate" class="slider" min="0.5" max="2" step="0.1" value="2.0">
                <span id="rate-value">2.0x</span>
            </div>

            <div class="control-group">
                <label>Pitch:</label>
                <input type="range" id="speech-pitch" class="slider" min="0.5" max="2" step="0.1" value="1.1">
                <span id="pitch-value">1.1x</span>
            </div>

            <div id="audio-feedback" class="audio-feedback">
                💡 Functional audio system with closure-based state management!
            </div>
        </div>

        <div id="kids-keyboard-tutor">
            <div id="kids-keyboard-output">
                <textarea id="kids-keyboard-text"
                          placeholder="Test the functional audio system - try both mouse clicks and keyboard typing!"></textarea>
                <div id="kids-keyboard-display">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        🎯 Functional Audio Test
                        <br><br>
                        <small>Testing closure-based audio optimization</small>
                    </div>
                </div>
            </div>
            <div id="kids-keyboard-input"></div>
        </div>
    </div>

    <!-- Load ONLY the functional versions -->
    <script src="../src/kids-keyboard.js"></script>
    <script src="../src/performance/kids-keyboard-audio-functional.js"></script>
    <script>
        console.log('🎵 Functional Audio System Test');

        let audioSystem = null;

        // Update audio status display (define first)
        const updateAudioStatus = (success = true) => {
            const statusEl = document.getElementById('audio-status');

            if (!success || !audioSystem) {
                statusEl.innerHTML = '❌ Functional audio system failed to initialize';
                statusEl.className = 'status-indicator error';
                return;
            }

            const status = audioSystem.getStatus();

            if (status.supported && status.initialized) {
                statusEl.innerHTML = `✅ Functional audio ready! ${status.voicesAvailable} voices available. Selected: ${status.selectedVoice}`;
                statusEl.className = 'status-indicator ready';
            } else if (status.supported) {
                statusEl.innerHTML = '🔄 Loading voices (functional)...';
                statusEl.className = 'status-indicator';
            } else {
                statusEl.innerHTML = '❌ Web Speech API not supported in this browser';
                statusEl.className = 'status-indicator error';
            }
        };

        // Initialize functional audio system
        const initializeAudio = async () => {
            try {
                console.log('🔧 Creating functional audio system...');
                audioSystem = await createKidsKeyboardAudio({
                    enabled: true,
                    rate: 2.0,  // Fast rate for reduced lag
                    pitch: 1.1
                });

                console.log('✅ Functional audio system initialized:', audioSystem.getStatus());
                updateAudioStatus();
                setupAudioControls();

            } catch (error) {
                console.error('❌ Failed to initialize functional audio:', error);
                updateAudioStatus(false);
            }
        };

        // Initialize keyboard with functional audio integration
        const keyboard = createKidsKeyboard({
            container: '#kids-keyboard-input',
            targetOutput: '#kids-keyboard-text',
            tutorContainer: '#kids-keyboard-tutor',
            debug: true,

            onKeyPress: (key, event, inputSource) => {
                console.log('🎹 Key pressed:', key, 'from', inputSource);

                // Use functional audio system
                if (audioSystem) {
                    if (inputSource === 'physical') {
                        // Physical keyboard: fast, simple audio
                        audioSystem.playPhysicalKeySound(key);
                    } else if (inputSource === 'virtual') {
                        // Virtual keyboard: detailed, educational audio
                        audioSystem.playVirtualKeySound(key);
                    } else {
                        // Fallback
                        audioSystem.playKeySound(key);
                    }
                }

                // Update display
                updateKeyDisplay(key, inputSource);
            },

            onTutorModeChange: (isActive) => {
                console.log('🎯 Tutor mode:', isActive ? 'ON' : 'OFF');
            }
        });

        // Setup audio controls (called after audio system is initialized)
        const setupAudioControls = () => {
            const audioToggle = document.getElementById('audio-toggle');
            const speechRate = document.getElementById('speech-rate');
            const speechPitch = document.getElementById('speech-pitch');
            const rateValue = document.getElementById('rate-value');
            const pitchValue = document.getElementById('pitch-value');

            // Audio toggle
            audioToggle.addEventListener('click', () => {
                if (!audioSystem) return;
                const enabled = audioSystem.toggle();
                audioToggle.textContent = enabled ? '🔊 ON' : '🔇 OFF';
                audioToggle.className = `toggle-button ${enabled ? 'active' : ''}`;
            });

            // Speech rate control
            speechRate.addEventListener('input', (e) => {
                if (!audioSystem) return;
                const rate = parseFloat(e.target.value);
                audioSystem.setRate(rate);
                rateValue.textContent = rate + 'x';
            });

            // Speech pitch control
            speechPitch.addEventListener('input', (e) => {
                if (!audioSystem) return;
                const pitch = parseFloat(e.target.value);
                audioSystem.setPitch(pitch);
                pitchValue.textContent = pitch + 'x';
            });

            // Set initial values from config
            const config = audioSystem.getConfig();
            speechRate.value = config.rate;
            speechPitch.value = config.pitch;
            rateValue.textContent = config.rate + 'x';
            pitchValue.textContent = config.pitch + 'x';
            audioToggle.textContent = config.enabled ? '🔊 ON' : '🔇 OFF';
            audioToggle.className = `toggle-button ${config.enabled ? 'active' : ''}`;
        };

        // Update key display
        function updateKeyDisplay(key, inputSource = 'unknown') {
            const display = document.getElementById('kids-keyboard-display');
            const feedback = document.getElementById('audio-feedback');
            const keyUpper = key.toUpperCase();

            let content = `<div style="text-align: center;">`;

            // Input source indicator
            const sourceIcon = inputSource === 'physical' ? '⌨️' : inputSource === 'virtual' ? '🖱️' : '❓';
            const sourceText = inputSource === 'physical' ? 'Physical Keyboard' : inputSource === 'virtual' ? 'Virtual Keyboard' : 'Unknown';
            content += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">${sourceIcon} ${sourceText}</div>`;

            content += `<div style="font-size: 48px; margin: 20px 0; color: #4CAF50;">${keyUpper}</div>`;

            if (key.length === 1 && /[a-z]/i.test(key)) {
                content += `<div style="font-size: 18px; margin: 10px 0;">Letter: <strong>${keyUpper}</strong></div>`;

                if (inputSource === 'physical') {
                    content += `<div style="font-size: 16px; color: #666;">🔊 Functional PK: "${key.toLowerCase()}"</div>`;
                    feedback.textContent = `⌨️ Functional Physical: "${key.toLowerCase()}"`;
                } else if (inputSource === 'virtual') {
                    content += `<div style="font-size: 16px; color: #666;">🔊 Functional VK: "Letter ${keyUpper}. ${keyUpper} says ${getPhoneticSound(key)}"</div>`;
                    feedback.textContent = `🖱️ Functional Virtual: "Letter ${keyUpper}. ${keyUpper} says ${getPhoneticSound(key)}"`;
                }
            } else if (key.length === 1 && /[0-9]/.test(key)) {
                content += `<div style="font-size: 18px; margin: 10px 0;">Number: <strong>${key}</strong></div>`;

                if (inputSource === 'physical') {
                    content += `<div style="font-size: 16px; color: #666;">🔊 Functional PK: "${key}"</div>`;
                    feedback.textContent = `⌨️ Functional Physical: "${key}"`;
                } else if (inputSource === 'virtual') {
                    content += `<div style="font-size: 16px; color: #666;">🔊 Functional VK: "Number ${key}. ${key} is ${getNumberWord(key)}"</div>`;
                    feedback.textContent = `🖱️ Functional Virtual: "Number ${key}. ${key} is ${getNumberWord(key)}"`;
                }
            } else {
                content += `<div style="font-size: 18px; margin: 10px 0;">Key: <strong>${keyUpper}</strong></div>`;
                content += `<div style="font-size: 16px; color: #666;">🔊 Functional function key</div>`;
                feedback.textContent = `🎵 Functional: ${keyUpper} function key`;
            }

            content += `</div>`;
            display.innerHTML = content;

            // Show active feedback
            feedback.className = 'audio-feedback active';

            // Reset feedback after a delay
            setTimeout(() => {
                feedback.className = 'audio-feedback';
                feedback.textContent = '💡 Functional closure-based audio system working!';
            }, 3000);
        }

        // Helper functions
        function getPhoneticSound(letter) {
            const sounds = {
                'a': 'ah', 'b': 'buh', 'c': 'kuh', 'd': 'duh', 'e': 'eh',
                'f': 'fuh', 'g': 'guh', 'h': 'huh', 'i': 'ih', 'j': 'juh',
                'k': 'kuh', 'l': 'luh', 'm': 'muh', 'n': 'nuh', 'o': 'oh',
                'p': 'puh', 'q': 'kwuh', 'r': 'ruh', 's': 'suh', 't': 'tuh',
                'u': 'uh', 'v': 'vuh', 'w': 'wuh', 'x': 'ksuh', 'y': 'yuh', 'z': 'zuh'
            };
            return sounds[letter.toLowerCase()] || letter;
        }

        function getNumberWord(number) {
            const words = {
                '0': 'zero', '1': 'one', '2': 'two', '3': 'three', '4': 'four',
                '5': 'five', '6': 'six', '7': 'seven', '8': 'eight', '9': 'nine'
            };
            return words[number] || number;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            initializeAudio();
            console.log('🎯 Test the functional audio system by typing or clicking keys!');
        });
    </script>
</body>
</html>