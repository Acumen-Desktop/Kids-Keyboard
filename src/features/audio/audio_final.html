<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Keyboard - Audio System</title>
    <link rel="stylesheet" href="../src/kids-keyboard.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            min-height: 100vh;
            padding: 20px;
        }

        #app-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 1000px;
            padding: 30px;
        }

        h1 {
            color: #4a5568;
            margin-bottom: 30px;
            text-align: center;
        }

        .audio-controls {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
        }

        .audio-controls h3 {
            color: #2d3748;
            margin-bottom: 15px;
            margin-top: 0;
        }

        .control-group {
            align-items: center;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .control-group label {
            font-weight: 500;
            min-width: 100px;
        }

        .toggle-button {
            background: #e2e8f0;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }

        .toggle-button.active {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }

        .slider {
            flex: 1;
            max-width: 200px;
        }

        .status-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            margin-bottom: 20px;
            padding: 15px;
        }

        .status-indicator.ready {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .audio-feedback {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            color: #1565c0;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .audio-feedback.active {
            background: #c8e6c9;
            border-color: #a5d6a7;
            color: #2e7d32;
        }

        /* Debug panel (collapsible) */
        .debug-panel {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .debug-header {
            align-items: center;
            background: #e8eaed;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            user-select: none;
        }

        .debug-content {
            display: none;
            font-family: monospace;
            font-size: 12px;
            padding: 15px;
        }

        .debug-content.open {
            display: block;
        }

        .debug-stats {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            margin-bottom: 15px;
        }

        .debug-stat {
            background: white;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        /* Visual feedback for clicked keys */
        .kids-keyboard__key--clicked {
            background: #ff9800 !important;
            transform: scale(0.95);
            transition: all 0.1s ease;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <h1>üéµ Kids Keyboard - Audio System</h1>

        <div id="audio-status" class="status-indicator">
            üîÑ Initializing dual-voice audio system...
        </div>

        <div class="audio-controls">
            <h3>üîä Audio Settings</h3>

            <div class="control-group">
                <label>Audio:</label>
                <button id="audio-toggle" class="toggle-button active">üîä ON</button>
            </div>

            <div class="control-group">
                <label>Speed:</label>
                <input type="range" id="speech-rate" class="slider" min="0.5" max="2" step="0.1" value="2.0">
                <span id="rate-value">2.0x</span>
            </div>

            <div class="control-group">
                <label>Pitch:</label>
                <input type="range" id="speech-pitch" class="slider" min="0.5" max="2" step="0.1" value="1.1">
                <span id="pitch-value">1.1x</span>
            </div>

            <div id="audio-feedback" class="audio-feedback">
                üí° Dual-voice system: Letters use two voices (fast + phonetic), numbers use single voice
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel">
            <div class="debug-header" onclick="toggleDebugPanel()">
                <span>üîß Debug Info</span>
                <span id="debug-toggle">‚ñº</span>
            </div>
            <div id="debug-content" class="debug-content">
                <div class="debug-stats">
                    <div class="debug-stat">
                        <div>Total Clicks</div>
                        <div id="total-clicks">0</div>
                    </div>
                    <div class="debug-stat">
                        <div>Successful</div>
                        <div id="successful-clicks">0</div>
                    </div>
                    <div class="debug-stat">
                        <div>Last Key</div>
                        <div id="last-key">None</div>
                    </div>
                    <div class="debug-stat">
                        <div>Voices</div>
                        <div id="voice-count">0</div>
                    </div>
                </div>
                <div>
                    <strong>Primary Voice:</strong> <span id="primary-voice">Loading...</span><br>
                    <strong>Secondary Voice:</strong> <span id="secondary-voice">Loading...</span><br>
                    <strong>Click Handler:</strong> <span id="click-status">Unknown</span>
                </div>
            </div>
        </div>

        <div id="kids-keyboard-tutor">
            <div id="kids-keyboard-output">
                <textarea id="kids-keyboard-text"
                          placeholder="Hover to activate tutor mode. Try both physical keyboard and mouse clicks!"></textarea>
                <div id="kids-keyboard-display">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        üéØ Click virtual keys to test dual-voice audio
                        <br><br>
                        <small>Letters: fast + phonetic | Numbers: single voice</small>
                    </div>
                </div>
            </div>
            <div id="kids-keyboard-input"></div>
        </div>
    </div>

    <!-- Load optimized versions with fixes -->
    <script src="../src/kids-keyboard.js"></script>
    <script src="../src/performance/kids-keyboard-click-patch.js"></script>
    <script src="../src/performance/kids-keyboard-audio-functional.js"></script>
    <script>
        console.log('üéµ Kids Keyboard Audio System - Final Version');

        let audioSystem = null;
        let keyboard = null;

        // Debug state
        let totalClicks = 0;
        let successfulClicks = 0;
        let lastKey = 'None';

        // Update debug info
        const updateDebugInfo = () => {
            document.getElementById('total-clicks').textContent = totalClicks;
            document.getElementById('successful-clicks').textContent = successfulClicks;
            document.getElementById('last-key').textContent = lastKey;
            
            if (audioSystem) {
                const status = audioSystem.getStatus();
                document.getElementById('voice-count').textContent = status.voicesAvailable;
                document.getElementById('primary-voice').textContent = status.primaryVoice;
                document.getElementById('secondary-voice').textContent = status.secondaryVoice;
            }
            
            if (keyboard && keyboard.getClickDebugInfo) {
                const clickInfo = keyboard.getClickDebugInfo();
                document.getElementById('click-status').textContent = 
                    `${clickInfo.handlerAttached ? 'Active' : 'Inactive'} (${clickInfo.clickCount})`;
            }
        };

        // Toggle debug panel
        window.toggleDebugPanel = () => {
            const content = document.getElementById('debug-content');
            const toggle = document.getElementById('debug-toggle');
            
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                toggle.textContent = '‚ñº';
            } else {
                content.classList.add('open');
                toggle.textContent = '‚ñ≤';
                updateDebugInfo();
            }
        };

        // Update audio status display
        const updateAudioStatus = (success = true) => {
            const statusEl = document.getElementById('audio-status');

            if (!success || !audioSystem) {
                statusEl.innerHTML = '‚ùå Audio system failed to initialize';
                statusEl.className = 'status-indicator error';
                return;
            }

            const status = audioSystem.getStatus();

            if (status.supported && status.initialized) {
                statusEl.innerHTML = `‚úÖ Dual-voice system ready! ${status.voicesAvailable} voices available.<br>
                    üéØ Primary (fast): ${status.primaryVoice}<br>
                    üîä Secondary (phonetics): ${status.secondaryVoice}`;
                statusEl.className = 'status-indicator ready';
            } else if (status.supported) {
                statusEl.innerHTML = 'üîÑ Loading voices...';
                statusEl.className = 'status-indicator';
            } else {
                statusEl.innerHTML = '‚ùå Web Speech API not supported in this browser';
                statusEl.className = 'status-indicator error';
            }
        };

        // Initialize audio system
        const initializeAudio = async () => {
            try {
                console.log('üîß Creating functional audio system...');
                audioSystem = await createKidsKeyboardAudio({
                    enabled: true,
                    rate: 2.0,  // Fast rate for reduced lag
                    pitch: 1.1
                });

                console.log('‚úÖ Audio system initialized:', audioSystem.getStatus());
                updateAudioStatus();
                setupAudioControls();

            } catch (error) {
                console.error('‚ùå Failed to initialize audio:', error);
                updateAudioStatus(false);
            }
        };

        // Initialize keyboard with audio integration
        const initializeKeyboard = () => {
            keyboard = createKidsKeyboard({
                container: '#kids-keyboard-input',
                targetOutput: '#kids-keyboard-text',
                tutorContainer: '#kids-keyboard-tutor',
                debug: false, // Set to true for detailed logging

                onKeyPress: (key, event, inputSource) => {
                    totalClicks++;
                    successfulClicks++;
                    lastKey = key;
                    
                    console.log('üéπ Key pressed:', key, 'from', inputSource);

                    // Use functional audio system
                    if (audioSystem) {
                        if (inputSource === 'physical') {
                            // Physical keyboard: fast, simple audio
                            audioSystem.playPhysicalKeySound(key);
                        } else if (inputSource === 'virtual') {
                            // Virtual keyboard: dual-voice for letters, single for numbers
                            audioSystem.playVirtualKeySound(key);
                        } else {
                            // Fallback
                            audioSystem.playKeySound(key);
                        }
                    }

                    // Update display
                    updateKeyDisplay(key, inputSource);
                    updateDebugInfo();
                },

                onTutorModeChange: (isActive) => {
                    console.log('üéØ Tutor mode:', isActive ? 'ON' : 'OFF');
                }
            });
        };

        // Setup audio controls
        const setupAudioControls = () => {
            const audioToggle = document.getElementById('audio-toggle');
            const speechRate = document.getElementById('speech-rate');
            const speechPitch = document.getElementById('speech-pitch');
            const rateValue = document.getElementById('rate-value');
            const pitchValue = document.getElementById('pitch-value');

            // Audio toggle
            audioToggle.addEventListener('click', () => {
                if (!audioSystem) return;
                const enabled = audioSystem.toggle();
                audioToggle.textContent = enabled ? 'üîä ON' : 'üîá OFF';
                audioToggle.className = `toggle-button ${enabled ? 'active' : ''}`;
            });

            // Speech rate control
            speechRate.addEventListener('input', (e) => {
                if (!audioSystem) return;
                const rate = parseFloat(e.target.value);
                audioSystem.setRate(rate);
                rateValue.textContent = rate + 'x';
            });

            // Speech pitch control
            speechPitch.addEventListener('input', (e) => {
                if (!audioSystem) return;
                const pitch = parseFloat(e.target.value);
                audioSystem.setPitch(pitch);
                pitchValue.textContent = pitch + 'x';
            });

            // Set initial values from config
            const config = audioSystem.getConfig();
            speechRate.value = config.rate;
            speechPitch.value = config.pitch;
            rateValue.textContent = config.rate + 'x';
            pitchValue.textContent = config.pitch + 'x';
            audioToggle.textContent = config.enabled ? 'üîä ON' : 'üîá OFF';
            audioToggle.className = `toggle-button ${config.enabled ? 'active' : ''}`;
        };

        // Update key display
        function updateKeyDisplay(key, inputSource = 'unknown') {
            const display = document.getElementById('kids-keyboard-display');
            const feedback = document.getElementById('audio-feedback');
            const keyUpper = key.toUpperCase();

            let content = `<div style="text-align: center;">`;

            // Input source indicator
            const sourceIcon = inputSource === 'physical' ? '‚å®Ô∏è' : inputSource === 'virtual' ? 'üñ±Ô∏è' : '‚ùì';
            const sourceText = inputSource === 'physical' ? 'Physical Keyboard' : inputSource === 'virtual' ? 'Virtual Keyboard' : 'Unknown';
            content += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">${sourceIcon} ${sourceText}</div>`;

            content += `<div style="font-size: 48px; margin: 20px 0; color: #4CAF50;">${keyUpper}</div>`;

            if (key.length === 1 && /[a-z]/i.test(key)) {
                content += `<div style="font-size: 18px; margin: 10px 0;">Letter: <strong>${keyUpper}</strong></div>`;

                if (inputSource === 'physical') {
                    content += `<div style="font-size: 16px; color: #666;">üîä Single voice: "${key.toLowerCase()}"</div>`;
                    feedback.textContent = `‚å®Ô∏è Physical: "${key.toLowerCase()}"`;
                } else if (inputSource === 'virtual') {
                    content += `<div style="font-size: 16px; color: #666;">üîä Dual voice: "${key.toLowerCase()}" then "${getPhoneticSound(key)}"</div>`;
                    content += `<div style="font-size: 14px; color: #888; margin-top: 5px;">üéØ Primary voice + üîä Secondary voice</div>`;
                    feedback.textContent = `üñ±Ô∏è Dual voice: "${key.toLowerCase()}" then "${getPhoneticSound(key)}"`;
                }
            } else if (key.length === 1 && /[0-9]/.test(key)) {
                content += `<div style="font-size: 18px; margin: 10px 0;">Number: <strong>${key}</strong></div>`;

                if (inputSource === 'physical') {
                    content += `<div style="font-size: 16px; color: #666;">üîä Single voice: "${key}"</div>`;
                    feedback.textContent = `‚å®Ô∏è Physical: "${key}"`;
                } else if (inputSource === 'virtual') {
                    content += `<div style="font-size: 16px; color: #666;">üîä Single voice: "${key}" (same as physical)</div>`;
                    content += `<div style="font-size: 14px; color: #888; margin-top: 5px;">üéØ No dual voice needed for numbers</div>`;
                    feedback.textContent = `üñ±Ô∏è Virtual: "${key}" (same as physical)`;
                }
            } else {
                content += `<div style="font-size: 18px; margin: 10px 0;">Key: <strong>${keyUpper}</strong></div>`;
                content += `<div style="font-size: 16px; color: #666;">üîä Function key</div>`;
                feedback.textContent = `üéµ Function: ${keyUpper}`;
            }

            content += `</div>`;
            display.innerHTML = content;

            // Show active feedback
            feedback.className = 'audio-feedback active';

            // Reset feedback after a delay
            setTimeout(() => {
                feedback.className = 'audio-feedback';
                feedback.textContent = 'üí° Dual-voice system: Letters use two voices (fast + phonetic), numbers use single voice';
            }, 3000);
        }

        // Helper functions
        function getPhoneticSound(letter) {
            const sounds = {
                'a': 'ah', 'b': 'buh', 'c': 'kuh', 'd': 'duh', 'e': 'eh',
                'f': 'fuh', 'g': 'guh', 'h': 'huh', 'i': 'ih', 'j': 'juh',
                'k': 'kuh', 'l': 'luh', 'm': 'muh', 'n': 'nuh', 'o': 'oh',
                'p': 'puh', 'q': 'kwuh', 'r': 'ruh', 's': 'suh', 't': 'tuh',
                'u': 'uh', 'v': 'vuh', 'w': 'wuh', 'x': 'ksuh', 'y': 'yuh', 'z': 'zuh'
            };
            return sounds[letter.toLowerCase()] || letter;
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üîÑ Initializing Kids Keyboard Audio System...');
            
            // Initialize in sequence
            await initializeAudio();
            initializeKeyboard();
            
            console.log('‚úÖ Kids Keyboard Audio System ready!');
            updateDebugInfo();
        });
    </script>
</body>
</html>